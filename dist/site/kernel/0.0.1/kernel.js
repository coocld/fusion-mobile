"use strict";define("site/kernel/kernel",["common/router/router","common/touchslider/touchslider","common/pointerevents/pointerevents","site/svgicos/svgicos","site/pages/pages","site/popups/popups"],function(e,t,n,i,o,s){function l(e,t,n,i){function o(o){var l;document.querySelector(s).insertAdjacentHTML("beforeEnd",'<div class="'+t+'">'+o+"</div>"),d(document.querySelector(s+" > ."+t)),"js"in e?(u.showLoading(),l=h+e.js,require([l],function(t){delete e.js,t&&u.extendIn(e,t,c),e.loaded=2,i(!0),u.hideLoading()},function(t){e.loaded=0,require.data.debug||t.requireType&&"scripterror"!==t.requireType&&"nodefine"!==t.requireType||t.xhr&&404!==t.xhr.status?(require.undef(l),r(l,t.message,n)):a(n),u.hideLoading()})):(e.loaded=2,i(!0))}var s,l,c,h,p,f,v;2===e.loaded?i():1!==e.loaded&&(e.loaded=1,n?(s="#page > .content",l="page",c=["onload","onloadend","onunload","onunloadend","onrightmenuclick","onleftmenuclick","rightMenuDomContent","leftMenuDomContent"]):(s="#popup > .content",l="popup",c=["onload","onloadend","onunload","onunloadend","open"]),h=l+"/"+t+"/",p=require.toUrl(h),"css"in e&&(u.appendCss(p+e.css),delete e.css),"html"in e?(u.showLoading(),f=p+e.html,v=new XMLHttpRequest,v.open("get",f,!0),v.onreadystatechange=function(){4===this.readyState&&(200===this.status?(delete e.html,o(this.responseText)):(e.loaded=0,require.data.debug||404!==this.status?r(f,this.status,n):a(n)),u.hideLoading())},v.send("")):o(""))}function r(e,t,n){u.alert("加载"+e+"时发生了一个错误: "+t,n?function(){history.back()}:void 0)}function a(e){e?location.reload():u.confirm("网站已经更新, 使用该功能需要先重新加载. 是否立即刷新本页?",function(e){e&&location.reload()})}function c(e,t,n,i){function o(e){this.removeEventListener(e.type,o,!1),i()}e.style.visibility="visible",n?(t.classList.add("panelTransR1"),e.classList.add("panelTransR2")):(t.classList.add("panelTransL1"),e.classList.add("panelTransL2")),"function"==typeof i&&d(e,o)}function d(e,t){"function"!=typeof t&&(t=h),e.addEventListener(u.names.aniEvt,t,!1)}function h(e){e.target===this&&(this.className.match(/ panelTrans[LR]1/)?this.style.right=this.style.visibility="":this.style.right=0,this.className=this.className.replace(/ panelTrans[LR][12]/,""))}var u={appendCss:function(e){var t=document.createElement("link");/\.less$/.test(e)?"object"==typeof less?(t.rel="stylesheet/less",t.href=e,less.sheets.push(t),less.refresh()):(t.rel="stylesheet",t.href=e.replace(/less$/,"css")):(t.rel="stylesheet",t.href=e),document.head.appendChild(t)},makeSvg:function(e){var t,n="http://www.w3.org/2000/svg",i=document.createElementNS(n,"svg");return i.setAttribute("version","1.1"),t=document.createElementNS(n,"path"),i.appendChild(t),e&&u.setSvgPath(i,e),i},setSvgPath:function(e,t){return e.setAttribute("viewBox","0 0 "+t.width+" "+t.height),e.firstChild.setAttribute("d",t.path),e},extendIn:function(e,t,n){for(var i=0;i<n.length;i++)n[i]in t&&(e[n[i]]=t[n[i]])},clone:function(e){var t,n;if(e instanceof Date)t=new Date(e.valueOf());else if(e instanceof RegExp)n="",e.ignoreCase&&(n+="i"),e.multiline&&(n+="m"),e.global&&(n+="g"),t=RegExp(e.source.RegEncode(),n);else if(e instanceof Error)n=e.message?e.message:"",t=e instanceof RangeError?RangeError(n):e instanceof ReferenceError?ReferenceError(n):e instanceof SyntaxError?SyntaxError(n):e instanceof TypeError?TypeError(n):e instanceof URIError?URIError(n):Error(n);else if(e instanceof Array)for(t=[],n=0;n<e.length;n++)t[n]=u.clone(e[n]);else if(e instanceof Object){t={};for(n in e)t[n]=u.clone(e[n])}else t=e;return t},isEqual:function(e,t){var n,i=Object.prototype.toString.call(e);if(i===Object.prototype.toString.call(t)){if("[object Object]"===i){if(Object.keys(e).length===Object.keys(t).length){for(n in e)if(!(n in t&&u.isEqual(e[n],t[n])))return!1;return!0}return!1}if("[object Array]"===i){if(e.length===t.length){for(n=0;n<e.length;n++)if(!u.isEqual(e[n],t[n]))return!1;return!0}return!1}return"[object String]"===i||"[object Number]"===i||"[object Undefined]"===i||"[object Null]"===i?e===t:!1}return!1},cancelEvent:function(e){e.preventDefault()},stopEvent:function(e){e.stopPropagation()}};return!function(){function e(e,t){var n,i,o;for(e.xEvents[t.type].locked=!0,n=0;n<e.xEvents[t.type].length;n++)e.xEvents[t.type][n].call(e,t);for(e.xEvents[t.type].locked=!1;e.xEvents[t.type].stack.length>0;)e.xEvents[t.type].stack[0]?(i=e.xEvents[t.type].indexOf(e.xEvents[t.type].stack[0][1]),e.xEvents[t.type].stack[0][0]?-1!==i&&e.xEvents[t.type].splice(i,1):-1===i&&e.xEvents[t.type].push(e.xEvents[t.type].stack[0][1])):e.xEvents[t.type].splice(0,e.xEvents[t.type].length),e.xEvents[t.type].stack.shift();if(0===e.xEvents[t.type].length&&(delete e.xEvents[t.type],e.removeEventListener?e.removeEventListener(t.type,e.xEvents,!1):e.detachEvent?e.detachEvent("on"+t.type,e.xEvents):e["on"+t.type]=null),e.xEvents.removeMark){delete e.xEvents.removeMark;for(o in e.xEvents)delete e.xEvents[o],e.removeEventListener?e.removeEventListener(o,e.xEvents,!1):e.detachEvent?e.detachEvent("on"+o,e.xEvents):e["on"+o]=null;e.xEvents=null}}u.listeners={add:function(t,n,i){t.xEvents||(t.xEvents=function(n){e(t,n)}),t.xEvents[n]||(t.xEvents[n]=[],t.xEvents[n].stack=[],t.xEvents[n].locked=!1,t.addEventListener?t.addEventListener(n,t.xEvents,!1):t.attachEvent?t.attachEvent("on"+n,t.xEvents):t["on"+n]=t.xEvents),t.xEvents[n].locked?t.xEvents[n].stack.push([!1,i]):t.xEvents[n].indexOf(i)<0&&t.xEvents[n].push(i)},list:function(e,t){var n,i;if(t)n=e.xEvents&&e.xEvents[t]?e.xEvents[t].slice(0):[];else if(n={},e.xEvents)for(i in e.xEvents)e.xEvents[i]instanceof Array&&e.xEvents[i].length>0&&(n[i]=e.xEvents[i].slice(0));return n},remove:function(e,t,n){var i,o,s;if(e.xEvents)if(t)e.xEvents[t]&&(e.xEvents[t].locked?n?e.xEvents[t].stack.push([!0,n]):e.xEvents[t].stack.push(null):n?(s=e.xEvents[t].indexOf(n),-1!==s&&e.xEvents[t].splice(s,1)):e.xEvents[t].splice(0,e.xEvents[t].length),0===e.xEvents[t].length&&(delete e.xEvents[t],e.removeEventListener?e.removeEventListener(t,e.xEvents,!1):e.detachEvent?e.detachEvent("on"+t,e.xEvents):e["on"+t]=null));else if(!e.xEvents.removeMark){for(i in e.xEvents)e.xEvents[i].locked?o=!0:(delete e.xEvents[i],e.removeEventListener?e.removeEventListener(i,e.xEvents,!1):e.detachEvent?e.detachEvent("on"+i,e.xEvents):e["on"+i]=null);o?e.xEvents.removeMark=!0:e.xEvents=null}}}}(),!function(){u.names={},"animation"in document.documentElement.style?(u.names.aniEvt="animationend",u.names.aniStyle="animation"):(u.names.aniEvt="webkitAnimationEnd",u.names.aniStyle="webkitAnimation"),"transition"in document.documentElement.style?(u.names.transEvt="transitionend",u.names.transStyle="transition"):(u.names.transEvt="webkitTransitionEnd",u.names.transStyle="webkitTransition"),"transform"in document.documentElement.style?u.names.transform="transform":u.names.transform="webkitTransform"}(),!function(){function e(e){0===this.scrollTop?this.scrollTop=1:this.scrollTop+this.clientHeight===this.scrollHeight&&(this.scrollTop-=1)}function t(e){e.target===this&&(this.scrollTo?this.scrollTo(0,0):this.scrollLeft=this.scrollTop=0)}u.scrollReload=function(e,t){var o,s,l,r;u.fixIosScrolling(e),r=n(e,function(n){if("start"===n.type){if(0===r.pointers.length&&(e.classList.contains("iosScrollFix")&&1===e.scrollTop||!e.classList.contains("iosScrollFix")&&0===e.scrollTop))return o=n.y,!0}else{var a;if(n.y>o)n.domEvent.preventDefault(),l||(l=u.makeSvg(i.reload),l.classList.add("reloadHint"),e.appendChild(l)),a=l.offsetHeight||l.clientHeight,n.y-o<2*a?(l.style.top=n.y-o-a+"px",l.classList.remove("pin"),l.style.opacity=(n.y-o)/a/2,l.style[u.names.transform]="rotate("+360*l.style.opacity+"deg)"):(l.style.top=a+"px",l.style.opacity=1,l.style[u.names.transform]=""),s=!0;else{if(n.y<o&&!s)return!0;l&&(e.removeChild(l),l=void 0)}"end"!==n.type&&"cancel"!==n.type||(l&&(e.removeChild(l),l.classList.contains("pin")&&("function"==typeof t?t():u.reloadPage()),l=void 0),s=!1)}})},u.fixIosScrolling=function(t){var n;"IOS"===browser.name&&(t.classList.add("iosScrollFix"),"none"==getComputedStyle(t).display?(n=t.style.display,t.style.display="block",t.scrollTop=1,t.style.display=n):t.scrollTop=1,t.addEventListener("scroll",e,!1))},u.getScrollHeight=function(e){return e.classList.contains("iosScrollFix")?e.scrollHeight-1:e.scrollHeight},"IOS"===browser.name&&window.addEventListener("touchmove",function(e){for(var t=e.target;t!=document.body;){if(t.classList.contains("iosScrollFix")||t.classList.contains("hScroll"))return;t=t.parentNode}e.preventDefault()},!1),window.addEventListener("scroll",t,!1),document.documentElement.addEventListener("scroll",t,!1),document.body.addEventListener("scroll",t,!1),document.getElementById("page").addEventListener("scroll",t,!1),document.getElementById("popup").addEventListener("scroll",t,!1)}(),!function(){function e(e){var t,n,s;o.src=e.img,"right"in e&&(o.style.right=e.right),"left"in e&&(o.style.left=e.left),"top"in e&&(o.style.top=e.top),"bottom"in e&&(o.style.bottom=e.bottom),"width"in e&&(o.style.width=e.width),"height"in e&&(o.style.height=e.height);for(s=0;s<i.childNodes.length;s++)t=i.childNodes[s],e.rows[s]?(t.style.height=e.rows[s],t.className="unflexable"):(t.style.height="auto",t.className="flexable");for(t=i.childNodes[1],s=0;s<t.childNodes.length;s++)n=t.childNodes[s],e.cells[s]?(n.style.width=e.cells[s],n.className="unflexable"):(n.style.width="auto",n.className="flexable")}var t,n=document.getElementById("helper"),i=n.firstChild,o=n.lastChild;n.addEventListener("click",function(i){t.length>1?(t.shift(),e(t[0])):n.style.display=""},!1),u.showHelper=function(i){t=i instanceof Array?i:[i],e(t[0]),n.style.display="block"}}(),!function(){function e(e,t){return o&&"function"==typeof s[o].onunload&&s[o].onunload()||"function"==typeof s[e].onload&&s[e].onload(t)}function t(e){o&&delete s[o].backParam,r=void 0,o=e,f.data=s[e].title,s[e].back?(v.lastChild.data=s[s[e].back].title,v.style.visibility="visible"):v.style.visibility="hidden"}function n(n,i){var l=o;return e(n,i)?!0:(c(document.querySelector("#popup>.content>."+n),document.querySelector("#popup>.content>."+o),n===s[o].back||n===r,function(){if(a=!1,t(n),"function"==typeof s[l].onunloadend&&s[l].onunloadend(),"function"==typeof s[o].onloadend&&s[o].onloadend(),"function"==typeof d){var e=d;d=void 0,e()}}),void(a=!0))}var o,r,a,d,h=document.getElementById("popup"),p=document.querySelector("#popup > .header > .close"),f=document.querySelector("#popup > .header > .title").firstChild,v=document.querySelector("#popup > .header > .back");u.openPopup=function(e,t){var n=s[e];n?l(n,e,!1,function(){"function"==typeof n.open?n.open(t):u.showPopup(e,t)}):u.hint("popup config not found: "+e)},u.showPopup=function(i,l){if(a)d=function(){u.showPopup(i,l)};else{var r;if(h.classList.contains("in")){if(o!==i)return n(i,l);"function"==typeof s[i].onload&&s[i].onload(l)||"function"==typeof s[i].onloadend&&s[i].onloadend()}else{if(e(i,l))return!0;r=document.querySelector("#popup>.content>."+i),r.style.right=0,r.style.visibility="visible",h.classList.add("in"),a=!0,"function"==typeof u.popupEvents.onshow&&u.popupEvents.onshow({type:"show",id:i}),t(i),u.hideReadable()}}},u.closePopup=function(e){if(a)d=function(){u.closePopup(e)};else{var t=u.getCurrentPopup();t&&(!e||t===e||e instanceof Array&&e.indexOf(t)>=0)&&("function"==typeof s[t].onunload&&s[t].onunload()||(h.classList.remove("in"),h.classList.add("out"),a=!0,delete s[t].backParam,"function"==typeof u.popupEvents.onhide&&u.popupEvents.onhide({type:"hide",id:t})))}},u.getCurrentPopup=function(){return h.classList.contains("in")?o:void 0},u.setPopupBackParam=function(e){h.classList.contains("in")&&(s[o].backParam=e)},u.setPopupBack=function(e,t){t?t in s&&(e?(s[t].back=e,o===t&&(v.lastChild.data=s[e].title)):(delete s[t].back,v.style.visibility="hidden")):h.classList.contains("in")&&(e?(v.lastChild.data=s[e].title,r=e):v.style.visibility="hidden")},u.setPopupTitle=function(e,t){t?t in s&&(s[t].title=e,o===t&&(f.data=e)):h.classList.contains("in")&&(f.data=e)},u.popupEvents={},p.appendChild(u.makeSvg(i.close)),p.addEventListener("click",function(){u.closePopup()},!1),v.insertBefore(u.makeSvg(i.back),v.firstChild),v.addEventListener("click",function(e){u.openPopup(r?r:s[o].back,s[o].backParam)},!1),h.addEventListener(u.names.aniEvt,function(e){var t,n;e.target===this&&(a=!1,this.classList.contains("out")?(this.classList.remove("out"),"function"==typeof u.popupEvents.onhideend&&u.popupEvents.onhideend({type:"hideend",id:o}),t=document.querySelector("#popup>.content>."+o),t.style.right=t.style.visibility="","function"==typeof s[o].onunloadend&&s[o].onunloadend(),o=void 0):("function"==typeof s[o].onloadend&&s[o].onloadend(),"function"==typeof u.popupEvents.onshowend&&u.popupEvents.onshowend({type:"showend",id:o})),"function"==typeof d&&(n=d,d=void 0,n()))},!1)}(),!function(){var e,t=document.getElementById("readable"),n=document.querySelector("#readable > .close"),o=document.querySelector("#readable > .content");u.fixIosScrolling(o),u.showReadable=function(n,i){"string"==typeof n?o.innerHTML=n:o.appendChild(n),t.className="in",e=i},u.hideReadable=function(){"in"===t.className&&(t.className="out","function"==typeof e&&e())},u.isReadableShowing=function(){return"in"===t.className},u.showForeign=function(e,t){u.showReadable('<iframe frameborder="0" style="position:absolute;width:100%;height:100%;" frameborder="no" scrolling="auto" src="'+e+'" sandbox="allow-same-origin allow-forms allow-scripts"></iframe>',t)},u.clearPopup=function(){u.isReadableShowing()&&u.hideReadable(),u.closePopup()},n.appendChild(u.makeSvg(i.close)),n.addEventListener("click",u.hideReadable,!1),t.addEventListener(u.names.aniEvt,function(e){if(e.target===this&&this.classList.contains("out")){for(;o.childNodes.length>0;)o.removeChild(o.firstChild);this.className=""}},!1)}(),!function(){function e(){""===d.style.visibility&&""===h.style.visibility&&""===c.style.visibility&&""===g.style.visibility&&document.body.classList.remove("mask")}function n(e,t,n){"visible"===h.style.visibility?a.push([e,t,n]):(p.className=e,"htmlDialog"===e?"string"==typeof t?f.innerHTML=t:f.appendChild(t):f.textContent=t,window.addEventListener("resize",o,!1),o(),document.body.classList.add("mask"),h.style.visibility="visible",l=n)}function o(){p.style.width=p.style.height="",p.style.bottom=p.style.right="auto",p.style.width=p.offsetWidth+"px",p.style.height=p.offsetHeight+"px",p.style.bottom=p.style.right=""}var s,l,r=0,a=[],c=document.getElementById("loading"),d=document.getElementById("hint"),h=document.getElementById("dialog"),p=h.querySelector("div"),f=p.querySelector(".content"),v=p.querySelector(".close"),g=document.getElementById("photoView"),m=g.querySelector(".close"),y=t(g.querySelector(".content"));u.showPhotoView=function(e,t){var n,i;for(n=0;n<e.length;n++)i=document.createElement("div"),i.style.backgroundImage="url("+e[n]+")",i.className="item",y.add(i);t?y.slideTo(t,!0):y.children.length>1&&y.onchange(),document.getElementById("photoView").style.visibility="visible",document.body.classList.add("mask")},u.hidePhotoView=function(){for(;y.children.length;)y.remove(0)},u.alert=function(e,t){n("alert",e,t)},u.confirm=function(e,t){n("confirm",e,t)},u.htmlDialog=function(e,t){n("htmlDialog",e,t)},u.closeDialog=function(t){var n;for(window.removeEventListener("resize",o,!1),h.style.visibility="",e(),"function"==typeof l&&l(t);f.childNodes.length;)f.removeChild(f.lastChild);l=void 0,a.length&&(n=a.shift(),u[n.shift()].apply(u,n))},u.showLoading=function(e){c.querySelector("div").lastChild.data=e?e:"正在努力加载中...",0===r&&(c.style.visibility="visible",document.body.classList.add("mask")),r++},u.hideLoading=function(){r>0&&(r--,0===r&&(c.style.visibility="",e(),"function"==typeof u.dialogEvents.onloaded&&u.dialogEvents.onloaded({type:"loaded"})))},u.isLoading=function(){return r>0},u.hint=function(e,t){document.querySelector("#hint > .text").firstChild.data=e,s?clearTimeout(s):d.style.opacity=1,s=setTimeout(function(){d.style.opacity="",s=void 0},t?t:5e3)},u.dialogEvents={},y.onchange=function(){var t,n;if(this.children.length>0){if(n="",this.children.length>1)for(t=0;t<this.children.length;t++)n+=t===this.current?"●":"○";document.querySelector("#photoView > .nav").firstChild.data=n}else g.style.visibility="",e()},v.appendChild(u.makeSvg(i.close)),v.addEventListener("click",u.closeDialog,!1),p.querySelector(".yes").addEventListener("click",u.closeDialog,!1),p.querySelector(".no").addEventListener("click",function(){u.closeDialog()},!1),m.appendChild(v.firstChild.cloneNode(!0)),m.addEventListener("click",u.hidePhotoView,!1)}(),!function(){function t(){var n,m,y=e.location.id,b=o[y];e.lastLocation.id&&(n=y.replace(/-.*$/,""),m=e.lastLocation.id.replace(/-.*$/,""),n!==m&&(n in p&&(p[n].className="selected",u.setSvgPath(p[n].firstChild,i[n+"-selected"])),m in p&&(p[m].className="",u.setSvgPath(p[m].firstChild,i[m]))),u.clearPopup()),l(b,y,!0,function(n){if(d)h=!0;else{var i,l,u,p,m=e.location.id;if(m!==a){for(u=document.getElementById("page"),u.classList.add(m),document.querySelector("#page > .header > .title").firstChild.data=o[m].title;g.childNodes.length;)g.removeChild(g.firstChild);for(;v.childNodes.length;)v.removeChild(v.firstChild);o[m].onrightmenuclick?("function"==typeof o[m].onrightmenuclick?g.href="javascript:;":g.href=o[m].onrightmenuclick,o[m].rightMenuDomContent&&g.appendChild(o[m].rightMenuDomContent),g.style.display=""):g.style.display="none",o[m].onleftmenuclick?("function"==typeof o[m].onleftmenuclick?v.href="javascript:;":v.href=o[m].onleftmenuclick,o[m].leftMenuDomContent&&v.appendChild(o[m].leftMenuDomContent),v.style.display="",f.style.display="none"):v.style.display="none",r(e.getDefaultBack()),i=document.querySelector("#page>.content>."+m),a?(u.classList.remove(a),l=a,a=m,p=e.isGoingback(l,m),d=!0,c(i,document.querySelector("#page>.content>."+l),p,function(){d=!1,"function"==typeof o[l].onunloadend&&o[l].onunloadend(!p),"function"==typeof o[m].onloadend&&o[m].onloadend(!p),h&&(h=!1,i.style.visibility="visible",t())}),"function"==typeof o[l].onunload&&o[l].onunload(),"function"==typeof o[m].onload&&o[m].onload(!p||n)):(a=m,i.style.right=0,i.style.visibility="visible",s(!0))}else s()}})}function n(){u.clearPopup(),"function"==typeof o[a].onunload&&o[a].onunload(!0),"function"==typeof o[a].onunloadend&&o[a].onunloadend(!0),"function"==typeof o[a].onload&&o[a].onload(!0),"function"==typeof o[a].onloadend&&o[a].onloadend(!0)}function s(e){"function"==typeof o[a].onload&&o[a].onload(e),"function"==typeof o[a].onloadend&&o[a].onloadend()}function r(t){if(t&&t.id){var n=o[t.id].title;n||(n="返回"),f.lastChild.data=n,f.href=e.buildHash(t),f.style.display=""}else f.href="#!",f.style.display="none"}var a,d,h,p={},f=document.querySelector("#page > .header > .back"),v=document.querySelector("#page > .header > .leftMenuBtn"),g=document.querySelector("#page > .header > .rightMenuBtn");u.init=function(n){var s,l=document.querySelector("#page > .navMenu");for(s in n)e.location||e.init(o,s),p[s]=document.createElement("a"),p[s].href="#!"+s,RegExp("^"+s+"(?:-|$)").test(e.location.id)?(p[s].className="selected",p[s].appendChild(u.makeSvg(i[s+"-selected"]))):p[s].appendChild(u.makeSvg(i[s])),p[s].appendChild(document.createTextNode(n[s])),l.appendChild(p[s]);"clean"===e.location.args.ui&&document.body.classList.add("clean"),u.listeners.add(e,"change",t),window.addEventListener("contextmenu","Firefox"===browser.name?u.stopEvent:u.cancelEvent,!1),window.addEventListener("dragstart",u.cancelEvent,!1),document.body.classList.remove("loading"),t(),"autopopup"in e.location.args&&u.openPopup(e.location.args.autopopup,e.location.args.autopopuparg)},u.reloadPage=function(){function t(o){u.listeners.remove(this,o.type,t),e.isSameLocation(i,e.location)&&n()}var i;u.isLoading()?(i=e.location,u.listeners.add(u.dialogEvents,"loaded",t)):n()},f.insertBefore(u.makeSvg(i.back),f.firstChild),g.addEventListener("click",function(e){"function"==typeof o[a].onrightmenuclick&&o[a].onrightmenuclick()},!1),v.addEventListener("click",function(e){"function"==typeof o[a].onleftmenuclick&&o[a].onleftmenuclick()},!1)}(),u});